<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
        <%= title || '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏ï‡∏≤‡∏ü' %>
    </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="navline">
        <div class="navline__inner">
            <div class="links">
                <a href="/">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
                <a href="#">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</a>
            </div>
            <div class="avatar" aria-label="profile"></div>
        </div>
    </div>

    <header class="ribbon">
        <div class="ribbon__inner">
            <h1>ITCamp21</h1>
            <small>üíé‚ùÑÔ∏è ITCAMP 21 | The Glacial Horizon ‚ùÑÔ∏èüíé</small>
        </div>
    </header>

    <main class="page" id="pageRoot" data-event-id="<%= eventId %>" data-api-base="<%= apiBase || '/api' %>">>
        <form id="applyForm" class="formgrid" novalidate>
            <div class="field">
                <label for="student_code">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
                <input id="student_code" name="student_code" type="text">
            </div>
            <div class="field">
                <label for="title">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label>
                <input id="title" name="title" type="text">
            </div>

            <div class="field">
                <label for="first_name">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á</label>
                <input id="first_name" name="first_name" type="text" required>
            </div>
            <div class="field">
                <label for="last_name">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                <input id="last_name" name="last_name" type="text" required>
            </div>

            <div class="field">
                <label for="nickname">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                <input id="nickname" name="nickname" type="text">
            </div>
            <div class="field">
                <label for="phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                <input id="phone" name="phone" type="tel">
            </div>

            <div class="field">
                <label for="email">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                <input id="email" name="email" type="email" required>
            </div>
            <div></div>

            <div class="field">
                <label>‡∏™‡∏≤‡∏Ç‡∏≤</label>
                <div class="radio-col">
                    <label class="radio"><input type="radio" name="major" value="IT" required> IT</label>
                    <label class="radio"><input type="radio" name="major" value="DSBA"> DSBA</label>
                    <label class="radio"><input type="radio" name="major" value="BIT"> BIT</label>
                    <label class="radio"><input type="radio" name="major" value="AIT"> AIT</label>
                </div>
            </div>

            <div class="field">
                <label>‡∏£‡∏∏‡πà‡∏ô</label>
                <div class="radio-col">
                    <label class="radio"><input type="radio" name="cohort" value="20" required> 20</label>
                    <label class="radio"><input type="radio" name="cohort" value="21"> 21</label>
                    <label class="radio"><input type="radio" name="cohort" value="22"> 22</label>
                    <label class="radio"><input type="radio" name="cohort" value="23"> 23</label>
                </div>
            </div>

            <div class="field">
                <label for="position_applied">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</label>
                <input id="position_applied" name="position_applied" type="text">
            </div>
            <div class="field">
                <label for="experience">‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</label>
                <input id="experience" name="experience" type="text">
            </div>

            <div class="field full">
                <label for="motivation">‡∏ó‡∏≥‡πÑ‡∏°‡∏ñ‡∏∂‡∏á‡∏≠‡∏¢‡∏≤‡∏Å‡∏°‡∏≤‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ</label>
                <input id="motivation" name="motivation" type="text">
            </div>

            <div id="msg" class="full"></div>

            <div class="actions full">
                <button class="btn" type="reset">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button id="submitBtn" class="btn primary" type="submit">‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</button>
            </div>
        </form>
    </main>

    <script>
        const root = document.getElementById('pageRoot');
        const EVENT_ID = Number(root.dataset.eventId);
        const API_BASE = root.dataset.apiBase;

        const form = document.getElementById('applyForm');
        const btn = document.getElementById('submitBtn');
        const msg = document.getElementById('msg');

        function flash(ok, text) {
            msg.className = 'full alert ' + (ok ? 'alert-success' : 'alert-danger');
            msg.textContent = text;
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            msg.className = 'full'; msg.textContent = '';

            const raw = Object.fromEntries(new FormData(form).entries());
            const data = Object.fromEntries(Object.entries(raw).map(([k, v]) => [k, (v?.trim?.() ?? v) || null]));

            if (!data.first_name || !data.last_name || !data.email) return flash(false, '‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•-‡∏≠‡∏µ‡πÄ‡∏°‡∏•');
            if (!data.major || !data.cohort) return flash(false, '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏∏‡πà‡∏ô');
            if (data.cohort != null) data.cohort = Number(data.cohort);

            const headers = { 'Content-Type': 'application/json' };
            const jwt = localStorage.getItem('jwt');
            if (jwt) headers.Authorization = `Bearer ${jwt}`;

            btn.disabled = true; btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
            try {
                const res = await fetch(`${API_BASE}/events/${EVENT_ID}/staff-applications`, {
                    method: 'POST', headers, body: JSON.stringify(data)
                });
                const json = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error(json.message || `Error ${res.status}`);
                flash(true, '‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚ú®');
                form.reset();
            } catch (err) {
                flash(false, err.message || '‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } finally {
                btn.disabled = false; btn.textContent = '‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£';
            }
        });
    </script>
</body>

</html>